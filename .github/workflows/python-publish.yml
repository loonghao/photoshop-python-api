name: Upload Python Package

on:
  push:
    tags:
      - "v*"

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      # IMPORTANT: this permission is mandatory for trusted publishing
      id-token: write
      contents: write

    steps:
    - uses: actions/checkout@v4
      with:
        token: "${{ secrets.GITHUB_TOKEN }}"
        fetch-depth: 0
        ref: main
        
    - uses: olegtarasov/get-tag@v2.1.3
      id: get_tag_name
      with:
        tagRegex: "v(?<version>.*)"
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-dev.txt
        
    - name: Build package
      run: |
        nox -s build
        
    - name: Upload to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        packages-dir: dist
        
    - name: Generate changelog
      id: changelog
      uses: jaywcjlove/changelog-generator@main
      with:
        token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        filter-author: (|dependabot|renovate\\[bot\\]|dependabot\\[bot\\]|Renovate Bot)
        filter: '[R|r]elease[d]\s+[v|V]\d(\.\d+){0,2}'
        template: |
          ## Bugs
          {{fix}}
          ## Feature
          {{feat}}
          ## Breaking Changes
          {{breaking}}
          ## Updates
          {{chore}}
          ## Document
          {{docs}}
          ## Dependency
          {{deps}}
          ## Style
          {{style}}
          ## Test
          {{test}}
          ## CI
          {{ci}}
          ## Other
          {{other}}
          
    - uses: ncipollo/release-action@v1
      with:
        artifacts: "dist/*.whl"
        token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        body: |
          Comparing Changes: ${{ steps.changelog.outputs.compareurl }}

          ${{ steps.changelog.outputs.changelog }}
